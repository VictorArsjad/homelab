services:
  syncthing:
    image: lscr.io/linuxserver/syncthing:latest
    container_name: syncthing
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Jakarta
      # Keep GUI reachable only via the local loopback,
      # so all access goes through Tailscale Serve (HTTPS).
      - SYNCTHING_GUI_ADDRESS=127.0.0.1:8384
      # force IPv4 only to silence IPv6 fragment logs
      - SYNCTHING_LISTEN_ADDRESSES=quic4://0.0.0.0:22000,tcp4://0.0.0.0:22000
    volumes:
      - syncthing_config:/config
      - /srv/docker/syncthing/obsidian:/obsidian
    network_mode: service:tailscale-syncthing
    restart: unless-stopped
    depends_on:
      - tailscale-syncthing

  tailscale-syncthing:
    image: tailscale/tailscale:latest
    container_name: ts-syncthing
    hostname: syncthing
    restart: unless-stopped
    cap_add:
      - net_admin
      - net_raw
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - /srv/docker/tailscale-syncthing/config:/config
      - /srv/docker/tailscale-syncthing/state:/var/lib/tailscale
    environment:
      - TS_AUTHKEY=${TS_SYNCTHING_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_USERSPACE=false

volumes:
  syncthing_config:
